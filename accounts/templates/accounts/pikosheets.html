{% extends 'accounts/main.html' %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM - Pikosheets{% endblock %}</title>
	{% block favicon %}
    <link rel="icon" type="image/x-icon" href="{% static 'images/faviconpiko.ico' %}">
	{% endblock %}
    <style>
	#loader {
    text-align: center;
	}

	#l1 {
    width: 10%;
    height: 10%;
	}

	.hidden {
    display: none;
	}
	.cell-row {
    display: flex;
}
	.cell {
		width: 80px;
		border: 1px solid #555;
		height: 40px;
		outline: none;
		box-sizing: border-box;
	}
	.cell.header {
		text-align: center;
		background: #ddd;
	}
	.cell.header.active {
		background:#8A2BE2;
		color: white;
	}
	.cell:focus {
		background: #ddd;
		border: 3px solid dodgerblue;
	}
	#export-btn {
		background: #FF69B4;
		color: white;
		border: none;
		padding: 10px;
		display: inline-block;
		margin-bottom: 10px;
		cursor: pointer;
		
	.adddel {
			color: white;
			background-color: rgb(49, 49, 49);
			border-radius: 5px;
			border: solid coral 2px;
		}
    </style>
</head>
<body>
     <div class="grid-container">

      <!-- Header -->
      <header class="header">
        <div class="menu-icon" onclick="openSidebar()">
          <span class="material-icons-outlined">menu</span>
        </div>
        <div class="header-left">
        </div>
		{% if user.is_authenticated %}
		<div class="header-right">
          <span class="material-icons-outlined">login</span> Hello, {{request.user}}
          <span class="material-icons-outlined">app_registration</span> Logout
        </div>
		{% else %}
        <div class="header-right">
          <a href="{% url 'login' %}"><span class="material-icons-outlined">login</span> Login</a>
          <a href="{% url 'register' %}"><span class="material-icons-outlined">app_registration</span> Sign Up</a>
          <a href="{% url 'guest' %}"><span class="material-icons-outlined">transcribe</span> Guest</a>
        </div>
		{% endif %}
      </header>
      <!-- End Header -->

     <!-- Sidebar -->
     <aside id="sidebar">
        <div class="sidebar-title">
          <div class="sidebar-brand">
            <img src="{% static 'images/logocrm1.png' %}"> Pikocrm
          </div>
        </div>
        <ul class="sidebar-list">
          <li class="sidebar-list-item">
            <a href="{% url 'dashboard' %}">
              <span class="material-icons-outlined">dashboard_customize</span> Dashboard
            </a>
          </li>
		  <h3>GENERAL</h3>
          <li class="sidebar-list-item">
            <a href="{% url 'products' %}">
              <span class="material-icons-outlined">inventory_2</span> Inventory
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="{% url 'customert' %}">
              <span class="material-icons-outlined">people</span> Customers
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="{% url 'pikosheets' %}">
              <span class="material-icons-outlined">table_rows</span> Pikosheets
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="{% url 'todo' %}">
              <span class="material-icons-outlined">list_alt</span> Todo Lists
            </a>
          </li>
		  <h3>RETAIL</h3>
          <li class="sidebar-list-item">
            <a href="{% url 'barcode' %}">
              <span class="material-icons-outlined">qr_code</span> Barcode
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="{% url 'invoice' %}">
              <span class="material-icons-outlined">category</span> Invoicing
            </a>
          </li>
          <h3>ONLINE</h3>
          <li class="sidebar-list-item">
            <a href="{% url 'orderstatus' %}">
              <span class="material-icons-outlined">inventory_2</span> Order Status
            </a>
          </li>
          <li class="sidebar-list-item">
            <a href="{% url 'support' %}">
              <span class="material-icons-outlined">support_agent</span> Support
            </a>
          </li>
        </ul>
      </aside>
      <!-- End Sidebar -->

      <!-- Main -->
		<main class="main-container">
		<div id="loader">
        <img id="l1" src="{% static 'images/pikogif1.gif' %}" alt="Loader">
		</div>
		<div id="content">
        <div class="main-title">
          <h2>PIKOSHEETS</h2>
        </div>
		<button id="export-btn">Export Pikosheet</button>
        <button id="export-btn"><div>Cell: <span id="cell-status"></span></div></button>
		<button class="btn btn-info" id="export-btn"><span class="material-icons-outlined" id="addColumns">add</span></button>
		<button class="btn btn-info" id="export-btn"><span class="material-icons-outlined" id="remcol">remove</span></div></button?
		<br>
		<div id=spreadsheet-container></div>
		</div>
		</main>
		</div>
    </body>
	<script>
	document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const content = document.getElementById("content");

    setTimeout(function () {
        loader.style.display = "none";

        content.classList.remove("hidden");
    }, 5000); // 5000 milliseconds (5 seconds)
	});
const spreadSheetContainer = document.querySelector("#spreadsheet-container")
const exportBtn = document.querySelector("#export-btn")
const ROWS = 20
let COLS = 13
let isInitialized = false
let spreadsheet = []
const alphabets = [
    "A",
    "B",
    "C",
    "D",
    "E",
    "F",
    "G",
    "H",
    "I",
    "J",
    "K",
    "L",
    "M",
    "N",
    "O",
    "P",
    "Q",
    "R",
    "S",
    "T",
    "U",
    "V",
    "W",
    "X",
    "Y",
    "Z",
]
class Cell {
    constructor(isHeader, disabled, data, row, column, rowName, columnName, active = false) {
        this.isHeader = isHeader
        this.disabled = disabled
        this.data = data
        this.row = row
        this.rowName = rowName
        this.column = column
        this.columnName = columnName
        this.active = active
    }
}

exportBtn.onclick = function (e) {
    let csv = ""
    for (let i = 0; i < spreadsheet.length; i++) {
        csv +=
            spreadsheet[i]
                .filter((item) => !item.isHeader)
                .map((item) => item.data)
                .join(",") + "\r\n"
    }

    const csvObj = new Blob([csv])
    const csvUrl = URL.createObjectURL(csvObj)
    console.log("csv", csvUrl)

    const a = document.createElement("a")
    a.href = csvUrl
    a.download = "Pikosheets.csv"
    a.click()
}

initSpreadsheet(COLS)

function initSpreadsheet(COLS) {
	spreadsheet = []
	if(isInitialized) {
    for (let i = 0; i < COLS; i++) {
	let spreadsheetRow = []
        for (let j = 0; j < COLS; j++) {
            let cellData = ""
            let isHeader = false
            let disabled = false
            if (j === 0) {
                cellData = i
                isHeader = true
                disabled = true
            }

            if (i === 0) {
                isHeader = true
                disabled = true
                cellData = alphabets[j - 1]
            }

            if (!cellData) {
                cellData = ""
            }
            const rowName = i
            const columnName = alphabets[j - 1]
            const cell = new Cell(isHeader, disabled, cellData, i, j, rowName, columnName, false)
            spreadsheetRow.push(cell)
        }  
		spreadsheet.push(spreadsheetRow)
    }
	console.log("spreadsheet", spreadsheet)
    drawSheet()
	}
	if(!isInitialized) { 
	for (let i = 0; i < COLS; i++) {
	let spreadsheetRow = []
        for (let j = 0; j < COLS; j++) {
            let cellData = ""
            let isHeader = false
            let disabled = false
            if (j === 0) {
                cellData = i
                isHeader = true
                disabled = true
            }

            if (i === 0) {
                isHeader = true
                disabled = true
                cellData = alphabets[j - 1]
            }

            if (!cellData) {
                cellData = ""
            }
            const rowName = i
            const columnName = alphabets[j - 1]
            const cell = new Cell(isHeader, disabled, cellData, i, j, rowName, columnName, false)
            spreadsheetRow.push(cell)
        }  
		spreadsheet.push(spreadsheetRow)
    }
	console.log("spreadsheet", spreadsheet)
    drawSheet()
	isInitialized = true
	}
	}
	
	// Function to add columns to the existing spreadsheet
function addColumns() {
    COLS += 1; // Increment the number of columns
    
    // Update the existing cells' column information
    for (let i = 0; i < spreadsheet.length; i++) {
        const newRow = [];
        for (let j = 0; j < COLS; j++) {
            let cellData = "";
            let isHeader = false;
            let disabled = false;
            if (j === 0) {
                cellData = i;
                isHeader = true;
                disabled = true;
            }

            if (i === 0) {
                isHeader = true;
                disabled = true;
                cellData = alphabets[j - 1];
            }

            if (!cellData) {
                cellData = "";
            }
            const rowName = i;
            const columnName = alphabets[j - 1];
            const cell = new Cell(isHeader, disabled, cellData, i, j, rowName, columnName, false);
            newRow.push(cell);
        }
        spreadsheet[i] = newRow;
    }
    
    console.log("spreadsheet (updated)", spreadsheet);
    drawSheet();
}


function drawSheet() {
    spreadSheetContainer.innerHTML = ""
    for (let i = 0; i < spreadsheet.length; i++) {
        const rowContainerEl = document.createElement("div")
        rowContainerEl.className = "cell-row"

        for (let j = 0; j < spreadsheet[i].length; j++) {
            const cell = spreadsheet[i][j]
            rowContainerEl.append(createCellEl(cell))
        }
        spreadSheetContainer.append(rowContainerEl)
    }
}

function createCellEl(cell) {
    const cellEl = document.createElement("input")
    cellEl.className = "cell"
    cellEl.id = "cell_" + cell.row + cell.column
    cellEl.value = cell.data
    cellEl.disabled = cell.disabled

    if (cell.isHeader) {
        cellEl.classList.add("header")
    }

    cellEl.onclick = () => handleCellClick(cell)
    cellEl.onchange = (e) => handleOnChange(e.target.value, cell)
    return cellEl
}

function handleCellClick(cell) {
    clearHeaderActiveStates()
    const columnHeader = spreadsheet[0][cell.column]
    const rowHeader = spreadsheet[cell.row][0]
    const columnHeaderEl = getElFromRowCol(columnHeader.row, columnHeader.column)
    const rowHeaderEl = getElFromRowCol(rowHeader.row, rowHeader.column)
    columnHeaderEl.classList.add("active")
    rowHeaderEl.classList.add("active")
    document.querySelector("#cell-status").innerHTML = cell.columnName + "" + cell.rowName
    // console.log("clicked cell", cell, "columnHeaderEl", columnHeaderEl, "rowHeaderEl", rowHeaderEl)
}

function handleOnChange(data, cell) {
    cell.data = data
}

function clearHeaderActiveStates() {
    for (let i = 0; i < spreadsheet.length; i++) {
        for (let j = 0; j < spreadsheet[i].length; j++) {
            const cell = spreadsheet[i][j]
            if (cell.isHeader) {
                let cellEl = getElFromRowCol(cell.row, cell.column)
                cellEl.classList.remove("active")
            }
        }
    }
}

function getElFromRowCol(row, col) {
    return document.querySelector("#cell_" + row + col)
}

document.getElementById("addColumns").addEventListener("click", addColumns);
document.getElementById("remcol").addEventListener("click", remColumns);

function addColumns() {
	COLS = COLS + 1
	initSpreadsheet(COLS)
}
function remColumns() {
	COLS = COLS - 1
	initSpreadsheet(COLS)
}

	</script>
</html>
{% endblock content %}